pipeline {
  agent any

  parameters {
    string(name: 'CONFIRM', defaultValue: '', description: 'Tapez "OUI" pour confirmer la destruction.')
  }

  stages {
    stage('üì• Copier terraform.tfstate du job apply') {
      steps {
        script {
          copyArtifacts(
            projectName: 'infra_aws',       // ‚¨ÖÔ∏è Nom exact du job Jenkins qui a fait l'apply
            selector: lastSuccessful(),     // Copie du dernier succ√®s
            filter: 'terraform.tfstate',
            target: '.',
            flatten: true
          )
        }
      }
    }

    stage('üßπ Confirmation') {
      when {
        expression { return params.CONFIRM == 'OUI' }
      }
      steps {
        echo "‚úÖ Confirmation valid√©e. On lance la destruction."
      }
    }

    stage('üîç V√©rification tfstate') {
      when {
        expression { return params.CONFIRM == 'OUI' }
      }
      steps {
        echo "üìÅ V√©rification de la pr√©sence du fichier terraform.tfstate..."
        sh '''
          echo "Contenu du r√©pertoire courant :"
          ls -lh
          echo "Contenu de terraform.tfstate (s'il existe) :"
          cat terraform.tfstate || echo "‚ùå terraform.tfstate introuvable"
        '''
      }
    }

    stage('‚ö†Ô∏è Terraform Destroy') {
      when {
        expression { return params.CONFIRM == 'OUI' }
      }
      steps {
        withCredentials([
          string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          echo "üö® Terraform destroy en cours..."
          sh '''
            terraform init
            terraform destroy -auto-approve
          '''
        }
      }
    }

    stage('‚õî Annulation') {
      when {
        expression { return params.CONFIRM != 'OUI' }
      }
      steps {
        echo "‚ùå Destruction annul√©e. Veuillez entrer CONFIRM=OUI pour valider."
      }
    }
  }

  post {
    always {
      echo "üßæ Fin du pipeline de destruction."
    }
  }
}
